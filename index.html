<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Êó•ÊñáN4Ê∏¨È©ó">

    <!-- Icons -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êó•ÊñáN4ÂñÆÂ≠óËàáÊñáÊ≥ïÊ∏¨È©óÁ≥ªÁµ±</title>
    <style>
    * {
        box-sizing: border-box;
        font-family: "Microsoft JhengHei", "Segoe UI", sans-serif;
    }
    body {
        background-color: #f5f5f5;
        margin: 0;
        padding: 20px;
        color: #333;
        line-height: 1.6;
    }
    .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 25px;
        position: relative;
    }
    h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #eee;
        padding-bottom: 15px;
    }
    .home-screen, .quiz-screen, .result-screen, .history-screen {
        display: none;
    }
    .home-screen.active, .quiz-screen.active, .result-screen.active, .history-screen.active {
        display: block;
    }
    .home-buttons {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 30px;
    }
    .home-btn {
        padding: 15px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 18px;
        transition: background-color 0.3s;
    }
    .home-btn:hover {
        background-color: #2980b9;
    }
    .home-btn.exit {
        background-color: #e74c3c;
    }
    .home-btn.exit:hover {
        background-color: #c0392b;
    }
    .home-btn.update {
        background-color: #2ecc71;
    }
    .home-btn.update:hover {
        background-color: #27ae60;
    }
    
    /* Ê∏¨È©óÈ°ûÂûãÈÅ∏ÊìáÊåâÈàïÊ®£Âºè */
    .count-buttons-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 15px;
    }
    .count-btn {
        margin: 0;
        padding: 15px 10px;
        background-color: #95a5a6;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    .count-btn.active {
        background-color: #2ecc71;
        font-weight: bold;
        transform: scale(1.02);
        box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
    }
    .count-btn:hover {
        background-color: #7f8c8d;
        transform: translateY(-2px);
    }
    .count-btn.active:hover {
        background-color: #27ae60;
    }
    
    /* È°åÁõÆÊï∏ÈáèËº∏ÂÖ•Ê°Ü */
    .question-count-input {
        margin: 20px 0;
        text-align: center;
    }
    .question-count-input label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
        color: #2c3e50;
    }
    .question-count-input input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        text-align: center;
    }
    
    .question {
        margin-bottom: 25px;
        padding: 15px;
        border-radius: 8px;
        background-color: #f9f9f9;
    }
    .question-number {
        font-weight: bold;
        color: #3498db;
        margin-bottom: 10px;
    }
    .question-text {
        font-size: 18px;
        margin-bottom: 15px;
        line-height: 1.5;
    }
    .kanji {
        font-size: 24px;
        font-weight: bold;
        color: #e74c3c;
        margin: 10px 0;
        text-align: center;
    }
    .options {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .option {
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .option:hover {
        background-color: #f0f0f0;
    }
    .option.selected {
        background-color: #d6eaf8;
        border-color: #3498db;
    }
    .option.correct {
        background-color: #d4edda;
        border-color: #28a745;
    }
    .option.incorrect {
        background-color: #f8d7da;
        border-color: #dc3545;
    }
    .explanation {
        margin-top: 15px;
        padding: 15px;
        background-color: #e8f4fc;
        border-radius: 5px;
        display: none;
    }
    .explanation.show {
        display: block;
    }
    .explanation-title {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 8px;
    }
    .option-explanation {
        margin-top: 10px;
        padding: 8px;
        background-color: #f8f9fa;
        border-radius: 4px;
        font-size: 14px;
    }
    .button-container {
        display: flex;
        justify-content: center;
        margin-top: 30px;
        gap: 15px;
        flex-wrap: wrap;
    }
    button {
        padding: 12px 25px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
    }
    button:hover {
        background-color: #2980b9;
    }
    button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
    }
    button.restart {
        background-color: #e67e22;
    }
    button.restart:hover {
        background-color: #d35400;
    }
    .stats {
        text-align: center;
        margin-bottom: 20px;
        font-size: 18px;
        color: #2c3e50;
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
    }
    .timer {
        font-weight: bold;
        color: #e74c3c;
    }
    .result {
        text-align: center;
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        background-color: #e8f4fc;
    }
    .result-title {
        font-weight: bold;
        font-size: 20px;
        margin-bottom: 10px;
        color: #2c3e50;
    }
    .wrong-questions {
        margin-top: 20px;
        text-align: left;
    }
    .wrong-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #e74c3c;
    }
    .history-list {
        margin-top: 20px;
    }
    .history-item {
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
    }
    .history-date {
        font-weight: bold;
        color: #2c3e50;
    }
    .history-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    .history-stat {
        flex: 1;
        min-width: 120px;
        text-align: center;
        padding: 5px;
    }
    .question-count-selector {
        margin: 20px 0;
        text-align: center;
    }
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        text-align: center;
    }
    .success-message {
        background-color: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        text-align: center;
    }
    .update-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 10px;
        height: 10px;
        background-color: #2ecc71;
        border-radius: 50%;
        z-index: 1001;
        animation: pulse 2s infinite;
    }
    .update-indicator.outdated {
        background-color: #e74c3c;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }


.main-type-buttons {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin-bottom: 10px;
}






/* Êñ∞Â¢ûÂ≠êÈ°ûÂûãÈÅ∏ÊìáÂô®Ê®£Âºè */
/* Â≠êÈ°ûÂûãÈÅ∏ÊìáÂô®Ê®£Âºè */
.subtype-selector {
    margin: 0 0 15px 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e9ecef;
    width: 100%;
}

.subtype-title {
    margin-bottom: 8px;
    font-weight: bold;
    color: #2c3e50;
    text-align: center;
    font-size: 14px;
}

.subtype-buttons-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
}



    
    /* ÊâãÊ©üÁâàÊ®£Âºè */
@media (max-width: 768px) {
    .subtype-buttons-container {
        grid-template-columns: repeat(2, 1fr);
    }
}


    @media (max-width: 768px) {
        .container {
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        .home-btn, button {
            padding: 18px;
            font-size: 16px;
        }
        .question-text {
            font-size: 16px;
        }
        .kanji {
            font-size: 20px;
        }
        .option {
            padding: 15px;
            font-size: 16px;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        .button-container {
            flex-direction: column;
            gap: 10px;
        }
        .button-container button {
            width: 100%;
        }
        .history-stats {
            flex-direction: column;
        }
        .history-stat {
            min-width: 100%;
            text-align: left;
            margin-bottom: 5px;
        }
        .stats {
            flex-direction: column;
            gap: 10px;
        }
        .count-buttons-container {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .count-btn {
            padding: 18px 15px;
            font-size: 18px;
            min-height: 60px;
        }
        .question-count-selector p {
            font-size: 18px;
            margin-bottom: 15px;
        }
    }
    
    /* Èò≤Ê≠¢ÊâãÊ©ü‰∏äÈªûÊìäÈ´ò‰∫Æ */
    * {
        -webkit-tap-highlight-color: transparent;
    }
    /* ÊîπÂñÑËß∏Êë∏È´îÈ©ó */
    button, .option {
        touch-action: manipulation;
    }
    /* Êñ∞Â¢ûÈáçÁµÑÂè•Â≠êÈ°åÂûãÁöÑÊ®£Âºè */
    .sentence-with-gap {
        font-size: 20px;
        margin: 15px 0;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        text-align: center;
        border: 2px dashed #3498db;
        line-height: 1.8;
    }
    .gap {
        color: #e74c3c;
        font-weight: bold;
        background-color: #fff;
        padding: 4px 12px;
        border-radius: 6px;
        margin: 0 8px;
        border: 2px solid #e74c3c;
        display: inline-block;
        min-width: 60px;
        text-align: center;
    }
    </style>

<!-- ËºâÂÖ•ÂàÜÈ°ûÂûãÈ°åÂ∫´ -->
<script src="reading.js"></script>
<script src="writing.js"></script>
<script src="vocabulary.js"></script>
<script src="synonym.js"></script>
<script src="grammar.js"></script>
<script src="reorder.js"></script>




</head>
<body>
    <div class="container">
        <div class="update-indicator" id="update-indicator"></div>
        <h1>Êó•ÊñáÊ∏¨È©óÁ≥ªÁµ±</h1>
        
        <!-- È¶ñÈ†Å -->
        <div id="home-screen" class="home-screen active">
            <div class="home-buttons">
                <button id="start-quiz-btn" class="home-btn">ÈñãÂßãÊ∏¨È©ó</button>
                <button id="update-btn" class="home-btn update">Ê™¢Êü•È°åÂ∫´Êõ¥Êñ∞</button>
                
<div class="question-count-selector">
    <p>ÈÅ∏ÊìáÊ∏¨È©óÈ°ûÂûãÔºö</p>
    
    <!-- Á¨¨‰∏ÄË°åÔºö‰∏ªË¶ÅÈ°ûÂûãÊåâÈàï -->
    <div class="main-type-buttons">
        <button id="count-past-btn" class="count-btn">Ê≠∑Â±ÜËÄÉÈ°å</button>
        <button id="count-vocab-btn" class="count-btn">ÂñÆÂ≠óÊ∏¨È©ó</button>
        <button id="count-simulate-btn" class="count-btn active">Ê®°Êì¨N4ËÄÉÈ°å</button>
    </div>
    
    <!-- Á¨¨‰∫åË°åÔºöÂ≠êÈ°ûÂûãÈÅ∏ÊìáÂô®ÔºàÊîæÂú®Ê®°Êì¨ËÄÉÈ°å‰∏ãÊñπÔºâ -->
    <div id="subtype-selector" class="subtype-selector">
        <p class="subtype-title">Ê®°Êì¨ËÄÉÈ°åÁ¥∞ÂàÜÈ°ûÂûãÔºö</p>
        <div class="subtype-buttons-container">
            <button id="subtype-reading" class="subtype-btn">Êº¢Â≠óËÆÄÈü≥</button>
            <button id="subtype-writing" class="subtype-btn">Êº¢Â≠óÊõ∏ÂØ´</button>
            <button id="subtype-vocabulary" class="subtype-btn">Ë©ûË™ûÂ°´Á©∫</button>
            <button id="subtype-synonym" class="subtype-btn">ËøëÁæ©ÊõøÊèõ</button>
            <button id="subtype-grammar" class="subtype-btn">ÊñáÊ≥ïÈÅ∏Êìá</button>
            <button id="subtype-reorder" class="subtype-btn">Âè•Â≠êÈáçÁµÑ</button>
        </div>
    </div>
    
    <div class="question-count-input">
        <label for="question-count">Ë´ãÂ°´ÂØ´Ê∏¨È©óÁöÑÈ°åÁõÆÊï∏Èáè(È†êË®≠30È°åÔºåÊØèÊ¨°ÊúÄÂ§ö100È°å)Ôºö</label>
        <input type="number" id="question-count" min="1" max="100" value="30">
    </div>
</div>



                <button id="view-history-btn" class="home-btn">Ê≠∑Âè≤Á¥ÄÈåÑÊü•Ë©¢</button>
                <button id="exit-btn" class="home-btn exit">ÁµêÊùüÊ∏¨È©ó</button>
            </div>
        </div>
        
        <!-- Ê∏¨È©óÈ†ÅÈù¢ -->
        <div id="quiz-screen" class="quiz-screen">
            <div class="stats">
                <span id="progress">Á¨¨ 1 È°å / ÂÖ± 10 È°å</span>
                <span id="score">ÂæóÂàÜ: 0/0</span>
                <span id="timer" class="timer">ÊôÇÈñì: 00:00</span>
            </div>
            
            <div id="quiz-container">
                <!-- È°åÁõÆÂ∞áÁî±JavaScriptÂãïÊÖãÁîüÊàê -->
            </div>
            
            <div class="button-container">
                <button id="prev-btn" disabled>‰∏ä‰∏ÄÈ°å</button>
                <button id="next-btn">‰∏ã‰∏ÄÈ°å</button>
                <button id="submit-btn" style="display: none;">Êèê‰∫§Á≠îÊ°à</button>
                <button id="back-home-btn" class="restart">ËøîÂõûÈ¶ñÈ†Å</button>
            </div>
        </div>
        
        <!-- ÁµêÊûúÈ†ÅÈù¢ -->
        <div id="result-screen" class="result-screen">
            <div id="result" class="result">
                <!-- Ê∏¨È©óÁµêÊûúÂ∞áÂú®ÈÄôË£°È°ØÁ§∫ -->
            </div>
            
            <div class="button-container">
                <button id="restart-btn" class="restart">ÈáçÊñ∞ÈñãÂßãÊ∏¨È©ó</button>
                <button id="result-back-home-btn">ËøîÂõûÈ¶ñÈ†Å</button>
            </div>
        </div>
        
        <!-- Ê≠∑Âè≤Á¥ÄÈåÑÈ†ÅÈù¢ -->
        <div id="history-screen" class="history-screen">
            <h2>Ê∏¨È©óÊ≠∑Âè≤Á¥ÄÈåÑ</h2>
            
            <div id="history-list" class="history-list">
                <!-- Ê≠∑Âè≤Á¥ÄÈåÑÂ∞áÂú®ÈÄôË£°È°ØÁ§∫ -->
            </div>
            
            <div class="button-container">
                <button id="history-back-home-btn">ËøîÂõûÈ¶ñÈ†Å</button>
                <button id="clear-history-btn" class="restart">Ê∏ÖÈô§Ê≠∑Âè≤Á¥ÄÈåÑ</button>
            </div>
        </div>
    </div>

    <script>
        // ÊáâÁî®ÁãÄÊÖã
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let isAnswered = [];
        let score = 0;
        let wrongQuestions = [];
        let selectedQuestions = [];
        let shuffledQuestions = [];
        let questionCount = 30;
        let isPastQuestions = false;
        let isVocabMode = false;
        let selectedSubType = null; // Êñ∞Â¢ûÔºöË®òÈåÑÈÅ∏ÊìáÁöÑÂ≠êÈ°åÂûã
        let timerInterval = null;
        let startTime = null;
        let elapsedTime = 0;
        let history = JSON.parse(localStorage.getItem('n4QuizHistory')) || [];
        
        // È°åÂ∫´Ë≥áÊñô (Â∞áÂæûÂ§ñÈÉ®JSÊñá‰ª∂ËºâÂÖ•)
        let questionBank = [];
        let pastQuestionBank = [];
        let vocabBank = [];

        // DOMÂÖÉÁ¥†
        const countSimulateBtn = document.getElementById('count-simulate-btn');
        const countPastBtn = document.getElementById('count-past-btn');
        const countVocabBtn = document.getElementById('count-vocab-btn');
        const questionCountInput = document.getElementById('question-count');

// Êñ∞Â¢ûÔºöÂ≠êÈ°ûÂûãÊåâÈàï
const subtypeReadingBtn = document.getElementById('subtype-reading');
const subtypeWritingBtn = document.getElementById('subtype-writing');
const subtypeVocabularyBtn = document.getElementById('subtype-vocabulary');
const subtypeSynonymBtn = document.getElementById('subtype-synonym');
const subtypeGrammarBtn = document.getElementById('subtype-grammar');
const subtypeReorderBtn = document.getElementById('subtype-reorder');




        const homeScreen = document.getElementById('home-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const historyScreen = document.getElementById('history-screen');
        const updateIndicator = document.getElementById('update-indicator');
        
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const viewHistoryBtn = document.getElementById('view-history-btn');
        const exitBtn = document.getElementById('exit-btn');
        const updateBtn = document.getElementById('update-btn');
        
        const quizContainer = document.getElementById('quiz-container');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const backHomeBtn = document.getElementById('back-home-btn');
        
        const restartBtn = document.getElementById('restart-btn');
        const resultBackHomeBtn = document.getElementById('result-back-home-btn');
        
        const historyBackHomeBtn = document.getElementById('history-back-home-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        
        const progressElement = document.getElementById('progress');
        const scoreElement = document.getElementById('score');
        const timerElement = document.getElementById('timer');
        const resultElement = document.getElementById('result');
        const historyListElement = document.getElementById('history-list');

// ========== Ê†∏ÂøÉÂäüËÉΩÂáΩÊï∏ ==========

function startQuiz() {
    console.log('ÈñãÂßãÊ∏¨È©óÔºåÊ®°Âºè:', isVocabMode ? 'ÂñÆÂ≠óÊ∏¨È©ó' : (isPastQuestions ? 'Ê≠∑Â±ÜËÄÉÈ°å' : 'Ê®°Êì¨N4ËÄÉÈ°å'));
    if (selectedSubType) {
        console.log('Â≠êÈ°åÂûã:', selectedSubType);
    }
    
    // ÈáçÁΩÆÁãÄÊÖã
    currentQuestionIndex = 0;
    userAnswers = [];
    isAnswered = [];
    score = 0;
    wrongQuestions = [];
    selectedQuestions = [];
    shuffledQuestions = [];
    elapsedTime = 0;

    // ÈÅ∏ÊìáÈ°åÂ∫´
    let sourceBank;
    if (isVocabMode) {
        sourceBank = vocabBank;
    } else if (isPastQuestions) {
        sourceBank = pastQuestionBank;
    } else {
        sourceBank = questionBank;
    }

    // Ê™¢Êü•È°åÂ∫´ÊòØÂê¶ÂèØÁî®
    if (!sourceBank || sourceBank.length === 0) {
        alert('È°åÂ∫´ËºâÂÖ•Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
        return;
    }

    // Ê†πÊìöÊòØÂê¶ÊúâÈÅ∏ÊìáÂ≠êÈ°åÂûã‰æÜË®àÁÆóÂèØÁî®È°åÁõÆÊï∏Èáè
    let availableQuestions;
    if (selectedSubType) {
        availableQuestions = sourceBank.filter(q => q.type === selectedSubType).length;
    } else {
        availableQuestions = sourceBank.length;
    }
    
    const actualQuestionCount = Math.min(questionCount, availableQuestions);
    
    console.log(`ÂèØÁî®È°åÁõÆ: ${availableQuestions}, ÈÅ∏ÊìáÈ°åÊï∏: ${actualQuestionCount}`);

    // ÈÅ∏ÊìáÈ°åÁõÆÈÇèËºØ
    if (selectedSubType) {
        // Â¶ÇÊûúÊúâÈÅ∏ÊìáÂ≠êÈ°åÂûãÔºåÂè™ÈÅ∏ÊìáË©≤È°ûÂûãÁöÑÈ°åÁõÆ
        selectedQuestions = selectQuestionsByType(sourceBank, selectedSubType, actualQuestionCount);
    } else if (isVocabMode || isPastQuestions) {
        // ÂñÆÂ≠óÊ∏¨È©óÊàñÊ≠∑Â±ÜËÄÉÈ°åÔºåÁõ¥Êé•Èö®Ê©üÈÅ∏Êìá
        selectedQuestions = selectRandomQuestions(sourceBank, actualQuestionCount);
    } else {
        // Ê®°Êì¨ËÄÉÈ°å‰∏îÊ≤íÊúâÈÅ∏ÊìáÂ≠êÈ°åÂûãÔºåÁ¢∫‰øùÈ°åÂûãÂπ≥ÂùáÂàÜÂ∏É
        selectedQuestions = selectQuestionsWithBalancedTypes(sourceBank, actualQuestionCount);
    }
    
    // Ê™¢Êü•ÈÅ∏ÊìáÁöÑÈ°åÁõÆÊòØÂê¶ÊúâÊïà
    selectedQuestions = selectedQuestions.filter(question => isValidQuestion(question));
    
    if (selectedQuestions.length === 0) {
        alert('Ê≤íÊúâÊúâÊïàÁöÑÈ°åÁõÆÂèØÁî®ÔºåË´ãÊ™¢Êü•È°åÂ∫´Ê†ºÂºè');
        return;
    }
    
    // Èö®Ê©üÊâì‰∫ÇÊØèÂÄãÈ°åÁõÆÁöÑÈÅ∏È†ÖÈ†ÜÂ∫è
    shuffledQuestions = selectedQuestions.map(question => shuffleOptions(question));
    
    userAnswers = new Array(selectedQuestions.length).fill(null);
    isAnswered = new Array(selectedQuestions.length).fill(false);
    
    console.log('ÊúÄÁµÇÈÅ∏ÊìáÈ°åÁõÆÊï∏Èáè:', selectedQuestions.length);
    
    // ÈñãÂßãË®àÊôÇ
    startTimer();
    
    // È°ØÁ§∫Ê∏¨È©óÈ†ÅÈù¢
    showScreen(quizScreen);
    displayQuestion(currentQuestionIndex);
    updateButtons();
    updateProgress();
}

// Ê™¢Êü•È°åÁõÆÊòØÂê¶ÊúâÊïà
function isValidQuestion(question) {
    if (!question) return false;
    if (!question.id) return false;
    if (!question.type) return false;
    if (!question.question) return false;
    if (!question.options || !Array.isArray(question.options) || question.options.length === 0) return false;
    if (typeof question.correctAnswer !== 'number' || question.correctAnswer < 0 || question.correctAnswer >= question.options.length) return false;
    
    // Ê™¢Êü•ÊØèÂÄãÈÅ∏È†ÖÊòØÂê¶ÊúâÂøÖË¶ÅÁöÑÂ±¨ÊÄß
    for (let option of question.options) {
        if (!option.text) return false;
        if (!option.explanation) return false;
    }
    
    return true;
}

// ÈÅ∏ÊìáÁâπÂÆöÈ°ûÂûãÁöÑÈ°åÁõÆ
function selectQuestionsByType(sourceBank, type, count) {
    const typeQuestions = sourceBank.filter(question => question.type === type && isValidQuestion(question));
    
    if (typeQuestions.length === 0) {
        console.error(`Ê≤íÊúâÊâæÂà∞ ${type} È°ûÂûãÁöÑÊúâÊïàÈ°åÁõÆ`);
        return [];
    }
    
    const actualCount = Math.min(count, typeQuestions.length);
    return shuffleArray([...typeQuestions]).slice(0, actualCount);
}

// Èö®Ê©üÈÅ∏ÊìáÈ°åÁõÆ
function selectRandomQuestions(sourceBank, count) {
    const validQuestions = sourceBank.filter(question => isValidQuestion(question));
    
    if (validQuestions.length === 0) {
        console.error('È°åÂ∫´‰∏≠Ê≤íÊúâÊúâÊïàÁöÑÈ°åÁõÆ');
        return [];
    }
    
    const actualCount = Math.min(count, validQuestions.length);
    return shuffleArray([...validQuestions]).slice(0, actualCount);
}

// ÈÅ∏ÊìáÈ°åÁõÆ‰∏¶Á¢∫‰øùÈ°åÂûãÂπ≥ÂùáÂàÜÂ∏É
function selectQuestionsWithBalancedTypes(sourceBank, count) {
    // ÂÖàÈÅéÊøæÊéâÁÑ°ÊïàÁöÑÈ°åÁõÆ
    const validQuestions = sourceBank.filter(question => isValidQuestion(question));
    
    if (validQuestions.length === 0) {
        console.error('È°åÂ∫´‰∏≠Ê≤íÊúâÊúâÊïàÁöÑÈ°åÁõÆ');
        return [];
    }
    
    // ÊåâÈ°åÂûãÂàÜÁµÑ
    const questionsByType = {};
    validQuestions.forEach(question => {
        if (!questionsByType[question.type]) {
            questionsByType[question.type] = [];
        }
        questionsByType[question.type].push(question);
    });
    
    // Ë®àÁÆóÊØèÁ®ÆÈ°åÂûãÊáâË©≤ÈÅ∏ÊìáÁöÑÈ°åÁõÆÊï∏Èáè
    const types = Object.keys(questionsByType);
    const questionsPerType = Math.ceil(count / types.length);
    
    let selectedQuestions = [];
    
    // ÂæûÊØèÁ®ÆÈ°åÂûã‰∏≠ÈÅ∏ÊìáÈ°åÁõÆ
    types.forEach(type => {
        const availableQuestions = questionsByType[type];
        const shuffled = shuffleArray([...availableQuestions]);
        const selected = shuffled.slice(0, Math.min(questionsPerType, availableQuestions.length));
        selectedQuestions = selectedQuestions.concat(selected);
    });
    
    // Â¶ÇÊûúÈÅ∏ÊìáÁöÑÈ°åÁõÆÂ§öÊñºÊâÄÈúÄÔºåÈö®Ê©üÁßªÈô§Â§öÈ§òÁöÑÈ°åÁõÆ
    if (selectedQuestions.length > count) {
        selectedQuestions = shuffleArray(selectedQuestions).slice(0, count);
    }
    
    // Â¶ÇÊûúÈÅ∏ÊìáÁöÑÈ°åÁõÆÂ∞ëÊñºÊâÄÈúÄÔºåÂæûÊâÄÊúâÈ°åÁõÆ‰∏≠Èö®Ê©üË£úÂÖÖ
    if (selectedQuestions.length < count) {
        const remainingCount = count - selectedQuestions.length;
        const allQuestions = shuffleArray([...validQuestions]);
        const additionalQuestions = allQuestions.filter(q => !selectedQuestions.includes(q)).slice(0, remainingCount);
        selectedQuestions = selectedQuestions.concat(additionalQuestions);
    }
    
    // ÊúÄÂæåÂÜçÈö®Ê©üÊâì‰∫Ç‰∏ÄÊ¨°
    return shuffleArray(selectedQuestions);
}

function setQuestionType(type) {
    if (type === 'past') {
        isPastQuestions = true;
        isVocabMode = false;
        selectedSubType = null; // ÈáçÁΩÆÂ≠êÈ°åÂûã
        updateCountButtonStates('past');
        showUpdateNotification(`Ê≠∑Â±ÜËÄÉÈ°åÊ®°Âºè`);
    } else if (type === 'vocab') {
        isPastQuestions = false;
        isVocabMode = true;
        selectedSubType = null; // ÈáçÁΩÆÂ≠êÈ°åÂûã
        updateCountButtonStates('vocab');
        showUpdateNotification(`ÂñÆÂ≠óÊ∏¨È©óÊ®°Âºè`);
    } else {
        isPastQuestions = false;
        isVocabMode = false;
        updateCountButtonStates('simulate');
        showUpdateNotification(`Ê®°Êì¨N4ËÄÉÈ°åÊ®°Âºè`);
    }
    
    // ÁßªÈô§ÊâÄÊúâÂ≠êÈ°ûÂûãÊåâÈàïÁöÑactiveÈ°ûÂà•ÔºàÁï∂ÈÅ∏ÊìáÂÖ∂‰ªñ‰∏ªË¶ÅÈ°ûÂûãÊôÇÔºâ
    if (type !== 'simulate') {
        const allSubtypeBtns = document.querySelectorAll('.subtype-btn');
        allSubtypeBtns.forEach(btn => btn.classList.remove('active'));
        selectedSubType = null;
    }
    
    updateQuestionCountLimit();
}

// Ë®≠ÁΩÆÂ≠êÈ°åÂûã
function setSubQuestionType(subType) {
    // ÁßªÈô§ÊâÄÊúâÂ≠êÈ°ûÂûãÊåâÈàïÁöÑactiveÈ°ûÂà•
    const allSubtypeBtns = document.querySelectorAll('.subtype-btn');
    allSubtypeBtns.forEach(btn => btn.classList.remove('active'));
    
    // ÁÇ∫Áï∂ÂâçÈªûÊìäÁöÑÊåâÈàïÊ∑ªÂä†activeÈ°ûÂà•
    const currentBtn = document.getElementById(`subtype-${subType}`);
    if (currentBtn) {
        currentBtn.classList.add('active');
    }
    
    // Ë®≠ÁΩÆÁÇ∫Ê®°Êì¨ËÄÉÈ°åÊ®°Âºè
    setQuestionType('simulate');
    
    // Ë®òÈåÑÈÅ∏ÊìáÁöÑÂ≠êÈ°åÂûã
    selectedSubType = subType;
    
    // Êõ¥Êñ∞È°åÁõÆÊï∏ÈáèÈôêÂà∂
    updateQuestionCountLimit();
    
    console.log(`ÈÅ∏Êìá‰∫ÜÂ≠êÈ°åÂûã: ${subType}`);
    showUpdateNotification(`ÈÅ∏Êìá‰∫Ü ${getSubTypeName(subType)} È°åÂûã`);
}

// Áç≤ÂèñÂ≠êÈ°åÂûã‰∏≠ÊñáÂêçÁ®±
function getSubTypeName(subType) {
    const typeNames = {
        'reading': 'Êº¢Â≠óËÆÄÈü≥',
        'writing': 'Êº¢Â≠óÊõ∏ÂØ´',
        'vocabulary': 'Ë©ûË™ûÂ°´Á©∫',
        'synonym': 'ËøëÁæ©ÊõøÊèõ',
        'grammar': 'ÊñáÊ≥ïÈÅ∏Êìá',
        'reorder': 'Âè•Â≠êÈáçÁµÑ'
    };
    return typeNames[subType] || subType;
}

// Êõ¥Êñ∞È°åÁõÆÊï∏ÈáèÈôêÂà∂
function updateQuestionCountLimit() {
    let maxQuestions = 0;
    
    if (isVocabMode) {
        maxQuestions = vocabBank.length;
    } else if (isPastQuestions) {
        maxQuestions = pastQuestionBank.length;
    } else {
        // Ê®°Êì¨ËÄÉÈ°åÔºöÂ¶ÇÊûúÊúâÈÅ∏ÊìáÂ≠êÈ°åÂûãÔºåÂè™Ë®àÁÆóË©≤Â≠êÈ°åÂûãÁöÑÈ°åÁõÆÊï∏Èáè
        if (selectedSubType) {
            // ÂæûÂ∑≤Âêà‰ΩµÁöÑ questionBank ‰∏≠ÈÅéÊøæË©≤È°ûÂûãÁöÑÈ°åÁõÆ
            const typeQuestions = questionBank.filter(q => q.type === selectedSubType);
            maxQuestions = typeQuestions.length;
        } else {
            maxQuestions = questionBank.length;
        }
    }
    questionCountInput.max = maxQuestions;
    questionCountInput.placeholder = `ÊúÄÂ§öÂèØÈÅ∏ ${maxQuestions} È°å`;
    
    if (questionCountInput.value > maxQuestions) {
        questionCountInput.value = maxQuestions;
    }
}

function updateCountButtonStates(selectedType) {
    countSimulateBtn.classList.remove('active');
    countPastBtn.classList.remove('active');
    countVocabBtn.classList.remove('active');
    
    switch(selectedType) {
        case 'simulate':
            countSimulateBtn.classList.add('active');
            break;
        case 'past':
            countPastBtn.classList.add('active');
            break;
        case 'vocab':
            countVocabBtn.classList.add('active');
            break;
    }
}
        // ========== ‰∫ã‰ª∂Áõ£ËÅΩÂô® ==========

function initEventListeners() {
    startQuizBtn.addEventListener('click', () => {
        // ÂæûËº∏ÂÖ•Ê°ÜÁç≤ÂèñÈ°åÁõÆÊï∏Èáè
        questionCount = parseInt(questionCountInput.value) || 30;
        
        // Ê™¢Êü•È°åÁõÆÊï∏ÈáèÊòØÂê¶ÊúâÊïàÔºà‰ΩøÁî®Êñ∞ÁöÑÈÇèËºØÔºâ
        let maxQuestions = parseInt(questionCountInput.max) || 0;
        
        if (questionCount < 1) {
            alert('È°åÁõÆÊï∏ÈáèÂøÖÈ†àÂ§ßÊñº0');
            return;
        }
        
        if (questionCount > maxQuestions) {
            alert(`È°åÁõÆÊï∏Èáè‰∏çËÉΩË∂ÖÈÅéÈ°åÂ∫´Á∏ΩÊï∏ (${maxQuestions})`);
            questionCountInput.value = maxQuestions;
            questionCount = maxQuestions;
        }
        
        startQuiz();
    });
    
    viewHistoryBtn.addEventListener('click', showHistory);
    exitBtn.addEventListener('click', exitApp);
    updateBtn.addEventListener('click', checkForUpdates);
    
    countSimulateBtn.addEventListener('click', () => setQuestionType('simulate'));
    countPastBtn.addEventListener('click', () => setQuestionType('past'));
    countVocabBtn.addEventListener('click', () => setQuestionType('vocab'));

    // Êñ∞Â¢ûÔºöÂ≠êÈ°ûÂûãÊåâÈàïÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
    document.getElementById('subtype-reading').addEventListener('click', () => setSubQuestionType('reading'));
    document.getElementById('subtype-writing').addEventListener('click', () => setSubQuestionType('writing'));
    document.getElementById('subtype-vocabulary').addEventListener('click', () => setSubQuestionType('vocabulary'));
    document.getElementById('subtype-synonym').addEventListener('click', () => setSubQuestionType('synonym'));
    document.getElementById('subtype-grammar').addEventListener('click', () => setSubQuestionType('grammar'));
    document.getElementById('subtype-reorder').addEventListener('click', () => setSubQuestionType('reorder'));
    
    prevBtn.addEventListener('click', prevQuestion);
    nextBtn.addEventListener('click', nextQuestion);
    submitBtn.addEventListener('click', submitQuiz);
    backHomeBtn.addEventListener('click', backToHome);
    
    restartBtn.addEventListener('click', restartQuiz);
    resultBackHomeBtn.addEventListener('click', backToHome);
    
    historyBackHomeBtn.addEventListener('click', backToHome);
    clearHistoryBtn.addEventListener('click', clearHistory);
}

        // ========== Ê∏¨È©óÊµÅÁ®ãÂáΩÊï∏ ==========

        function displayQuestion(index) {
            const question = shuffledQuestions[index];
            
            // Ê™¢Êü•È°åÁõÆÊòØÂê¶ÊúâÊïà
            if (!isValidQuestion(question)) {
                quizContainer.innerHTML = `
                    <div class="error-message">
                        È°åÁõÆË≥áÊñôÊ†ºÂºèÈåØË™§ÔºåÁÑ°Ê≥ïÈ°ØÁ§∫Ê≠§È°åÁõÆ„ÄÇ
                    </div>
                `;
                return;
            }
            
            let questionHTML = '';
            
            switch(question.type) {
                case "reading":
                    questionHTML = generateReadingQuestion(question, index);
                    break;
                case "writing":
                    questionHTML = generateWritingQuestion(question, index);
                    break;
                case "vocabulary":
                    questionHTML = generateVocabularyQuestion(question, index);
                    break;
                case "synonym":
                    questionHTML = generateSynonymQuestion(question, index);
                    break;
                case "grammar":
                    questionHTML = generateGrammarQuestion(question, index);
                    break;
                case "reorder":  // Êñ∞Â¢ûreorderÈ°ûÂûãÁöÑËôïÁêÜ
                    questionHTML = generateReorderQuestion(question, index);
                    break;
                default:
                    questionHTML = generateDefaultQuestion(question, index);
            }
            
            const explanationClass = isAnswered[index] ? 'explanation show' : 'explanation';
            const correctAnswerExplanation = question.options[question.correctAnswer]?.explanation || 'Ê≠§È°åÁõÆÊ≤íÊúâÊèê‰æõËß£Ë™™';
            
            questionHTML += `
                <div class="${explanationClass}">
                    <div class="explanation-title">Ëß£Ë™™Ôºö</div>
                    ${isAnswered[index] ? generateOptionExplanations(question) : correctAnswerExplanation}
                </div>
            `;
            
            quizContainer.innerHTML = questionHTML;
        }

        function generateReorderQuestion(question, index) {
            // Â¶ÇÊûúÊúâsentenceÂ±¨ÊÄßÔºåÈ°ØÁ§∫ÂÆåÊï¥ÁöÑÂè•Â≠ê
            let sentenceContent = '';
            if (question.sentence) {
                // ‰ΩøÁî®Ê≠£Ë¶èË°®ÈÅîÂºèÊõøÊèõÊâÄÊúâÁöÑ ‚òÖ
                const formattedSentence = question.sentence.replace(/‚òÖ/g, '<span class="gap">‚òÖ</span>');
                sentenceContent = `<div class="sentence-with-gap">${formattedSentence}</div>`;
            } else {
                // Â¶ÇÊûúÊ≤íÊúâsentenceÔºåÈ°ØÁ§∫ÈåØË™§Ë®äÊÅØ
                sentenceContent = `<div class="error-message">È°åÁõÆÁº∫Â∞ëÂè•Â≠êÂÖßÂÆπ</div>`;
            }
            
            return generateQuestionHTML(question, index, sentenceContent);
        }


function generateReadingQuestion(question, index) {
    const kanjiContent = question.kanji ? `<div class="kanji">${question.kanji}</div>` : '';
    return generateQuestionHTML(question, index, kanjiContent);
}

function generateWritingQuestion(question, index) {
    const kanaContent = question.kana ? `<div class="kanji">${question.kana}</div>` : '';
    return generateQuestionHTML(question, index, kanaContent);
}

function generateVocabularyQuestion(question, index) {
    const sentenceContent = question.sentence ? `<div class="question-text">${question.sentence}</div>` : '';
    return generateQuestionHTML(question, index, sentenceContent);
}

function generateSynonymQuestion(question, index) {
    const sentenceContent = question.sentence ? `<div class="question-text">${question.sentence}</div>` : '';
    return generateQuestionHTML(question, index, sentenceContent);
}

function generateGrammarQuestion(question, index) {
    const sentenceContent = question.sentence ? `<div class="question-text">${question.sentence}</div>` : '';
    return generateQuestionHTML(question, index, sentenceContent);
}

function generateDefaultQuestion(question, index) {
    return generateQuestionHTML(question, index, '');
}



        function generateQuestionHTML(question, index, extraContent) {
            let optionsHTML = '';
            const yearInfo = question.year && question.season ? 
                `<div style="font-size: 14px; color: #666; margin-bottom: 10px;">${question.year}Âπ¥ ${question.season}ËÄÉÈ°å</div>` : '';

            // Â∞çÊñºreorderÈ°ûÂûãÁöÑÈ°åÁõÆÔºåÈ°ØÁ§∫‰∏çÂêåÁöÑÊèêÁ§∫ÊñáÂ≠ó
            let questionText = question.question || 'È°åÁõÆÂÖßÂÆπÁº∫Â§±';
            if (question.type === "reorder") {
                questionText = "Ë´ãÈÅ∏ÊìáÊúÄÈÅ©ÂêàÂ°´ÂÖ• ‚òÖ ‰ΩçÁΩÆÁöÑÈÅ∏È†ÖÔºö";
            }
            
            question.options.forEach((option, i) => {
                const isSelected = userAnswers[index] === i;
                const isCorrect = isAnswered[index] && i === question.correctAnswer;
                const isIncorrect = isAnswered[index] && isSelected && i !== question.correctAnswer;
                
                let optionClass = 'option';
                if (isSelected) optionClass += ' selected';
                if (isCorrect) optionClass += ' correct';
                if (isIncorrect) optionClass += ' incorrect';
                
                const optionText = option.text || 'ÈÅ∏È†ÖÂÖßÂÆπÁº∫Â§±';
                
                optionsHTML += `
                    <div class="${optionClass}" onclick="selectOption(${i})">
                        ${optionText}
                    </div>
                `;
            });
            
            return `
                <div class="question">
                    <div class="question-number">ÂïèÈ°å ${index + 1}</div>
                    ${yearInfo}
                    <div class="question-text">${questionText}</div>
                    ${extraContent}
                    <div class="options">
                        ${optionsHTML}
                    </div>
                </div>
            `;
        }


        function generateOptionExplanations(question) {
            let explanationsHTML = '';
            
            question.options.forEach((option, i) => {
                const isCorrect = i === question.correctAnswer;
                const isSelected = userAnswers[currentQuestionIndex] === i;
                
                const optionText = option.text || 'ÈÅ∏È†ÖÂÖßÂÆπÁº∫Â§±';
                const explanationText = option.explanation || 'Ê≠§ÈÅ∏È†ÖÊ≤íÊúâÊèê‰æõËß£Ë™™';
                
                explanationsHTML += `
                    <div class="option-explanation" style="${isCorrect ? 'border-left: 4px solid #28a745;' : isSelected ? 'border-left: 4px solid #dc3545;' : ''}">
                        <strong>ÈÅ∏È†Ö ${i+1}: ${optionText}</strong><br>
                        ${explanationText}
                    </div>
                `;
            });
            
            return explanationsHTML;
        }

        function selectOption(optionIndex) {
            if (isAnswered[currentQuestionIndex]) return;
            
            userAnswers[currentQuestionIndex] = optionIndex;
            isAnswered[currentQuestionIndex] = true;
            
            const question = shuffledQuestions[currentQuestionIndex];
            if (optionIndex === question.correctAnswer) {
                score++;
            } else {
                if (!wrongQuestions.includes(question.id)) {
                    wrongQuestions.push(question.id);
                }
            }
            
            updateScore();
            displayQuestion(currentQuestionIndex);
            updateButtons();
        }

        function updateButtons() {
            prevBtn.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === shuffledQuestions.length - 1) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'inline-block';
                submitBtn.style.display = 'none';
            }
        }

        function updateProgress() {
            progressElement.textContent = `Á¨¨ ${currentQuestionIndex + 1} È°å / ÂÖ± ${shuffledQuestions.length} È°å`;
        }

        function updateScore() {
            const answeredCount = isAnswered.filter(Boolean).length;
            scoreElement.textContent = `ÂæóÂàÜ: ${score}/${answeredCount}`;
        }

        function nextQuestion() {
            if (currentQuestionIndex < shuffledQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
                updateButtons();
                updateProgress();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion(currentQuestionIndex);
                updateButtons();
                updateProgress();
            }
        }

        function submitQuiz() {
            stopTimer();
            saveHistory();
            showResults();
            showScreen(resultScreen);
        }

        function showResults() {
            const errorTypes = {
                reading: 0,
                writing: 0,
                vocabulary: 0,
                synonym: 0,
                grammar: 0,
                reorder: 0  
            };
            
            wrongQuestions.forEach(questionId => {
                let question = questionBank.find(q => q.id === questionId) || 
                              pastQuestionBank.find(q => q.id === questionId) ||
                              vocabBank.find(q => q.id === questionId);
                if (question && errorTypes.hasOwnProperty(question.type)) {
                    errorTypes[question.type]++;
                }
            });
            
            let resultHTML = `
                <div class="result-title">Ê∏¨È©óÂÆåÊàêÔºÅ</div>
                <div>ÊúÄÁµÇÂæóÂàÜ: ${score}/${shuffledQuestions.length}</div>
                <div>Áî®ÊôÇ: ${formatTime(elapsedTime)}</div>
                <div class="wrong-questions">
                    <div class="wrong-title">ÂêÑÈ°åÂûãÈåØË™§ÂàÜÊûêÔºö</div>
                    <ul>
                        <li>Êº¢Â≠óËÆÄÈü≥ÈåØË™§: ${errorTypes.reading}</li>
                        <li>Êº¢Â≠óÊõ∏ÂØ´ÈåØË™§: ${errorTypes.writing}</li>
                        <li>Ë©ûË™ûÂ°´Á©∫ÈåØË™§: ${errorTypes.vocabulary}</li>
                        <li>ËøëÁæ©Ë©ûÊõøÊèõÈåØË™§: ${errorTypes.synonym}</li>
                        <li>ÊñáÊ≥ïÈÅ∏ÊìáÈåØË™§: ${errorTypes.grammar}</li>
                        <li>Âè•Â≠êÈáçÁµÑÈåØË™§: ${errorTypes.reorder}</li>
                    </ul>
                </div>
            `;
            
            if (wrongQuestions.length > 0) {
                resultHTML += `
                    <div class="wrong-questions">
                        <div class="wrong-title">ÈåØË™§È°åÁõÆ:</div>
                        <ul>
                `;
                
                wrongQuestions.forEach(questionId => {
                    let originalQuestion = questionBank.find(q => q.id === questionId) || 
                                         pastQuestionBank.find(q => q.id === questionId) ||
                                         vocabBank.find(q => q.id === questionId);
                    
                    const shuffledQuestion = shuffledQuestions.find(q => q.id === questionId);
                    const userAnswerIndex = userAnswers[shuffledQuestions.indexOf(shuffledQuestion)];
                    
                    if (originalQuestion && shuffledQuestion) {
                        let questionText = '';
                        if (originalQuestion.type === "reading") {
                            questionText = `${originalQuestion.kanji || 'È°åÁõÆÂÖßÂÆπÁº∫Â§±'} - ÊÇ®ÁöÑÁ≠îÊ°à: ${shuffledQuestion.options[userAnswerIndex]?.text || 'Á≠îÊ°àÁº∫Â§±'} - Ê≠£Á¢∫Á≠îÊ°à: ${shuffledQuestion.options[shuffledQuestion.correctAnswer]?.text || 'Á≠îÊ°àÁº∫Â§±'}`;
                        } else if (originalQuestion.type === "writing") {
                            questionText = `${originalQuestion.kana || 'È°åÁõÆÂÖßÂÆπÁº∫Â§±'} - ÊÇ®ÁöÑÁ≠îÊ°à: ${shuffledQuestion.options[userAnswerIndex]?.text || 'Á≠îÊ°àÁº∫Â§±'} - Ê≠£Á¢∫Á≠îÊ°à: ${shuffledQuestion.options[shuffledQuestion.correctAnswer]?.text || 'Á≠îÊ°àÁº∫Â§±'}`;
                        } else {
                            questionText = `ÂïèÈ°å ${originalQuestion.id} - ÊÇ®ÁöÑÁ≠îÊ°à: ${shuffledQuestion.options[userAnswerIndex]?.text || 'Á≠îÊ°àÁº∫Â§±'} - Ê≠£Á¢∫Á≠îÊ°à: ${shuffledQuestion.options[shuffledQuestion.correctAnswer]?.text || 'Á≠îÊ°àÁº∫Â§±'}`;
                        }
                        
                        resultHTML += `<li>${questionText}</li>`;
                    }
                });
                
                resultHTML += `
                        </ul>
                    </div>
                `;
            } else {
                resultHTML += `<div class="success-message">ÊÅ≠ÂñúÔºÅÂÖ®ÈÉ®Á≠îÂ∞çÔºÅ</div>`;
            }
            
            resultElement.innerHTML = resultHTML;
        }

        // ========== Â∑•ÂÖ∑ÂáΩÊï∏ ==========

        function startTimer() {
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const now = new Date();
            elapsedTime = Math.floor((now - startTime) / 1000);
            
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            
            timerElement.textContent = `ÊôÇÈñì: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function shuffleOptions(question) {
            const optionsWithIndex = question.options.map((option, index) => ({...option, originalIndex: index}));
            const shuffledOptions = shuffleArray(optionsWithIndex);
            
            const newCorrectAnswerIndex = shuffledOptions.findIndex(option => option.originalIndex === question.correctAnswer);
            
            return {
                ...question,
                options: shuffledOptions.map(option => ({text: option.text, explanation: option.explanation})),
                correctAnswer: newCorrectAnswerIndex
            };
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function showScreen(screen) {
            homeScreen.classList.remove('active');
            quizScreen.classList.remove('active');
            resultScreen.classList.remove('active');
            historyScreen.classList.remove('active');
            
            screen.classList.add('active');
        }

        function backToHome() {
            stopTimer();
            showScreen(homeScreen);
        }

        function restartQuiz() {
            backToHome();
            setTimeout(() => startQuiz(), 100);
        }

        function showHistory() {
            historyListElement.innerHTML = '';
            
            if (history.length === 0) {
                historyListElement.innerHTML = '<p>Â∞öÁÑ°Ê∏¨È©óÁ¥ÄÈåÑ</p>';
            } else {
                history.forEach((record, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    const date = new Date(record.date);
                    const formattedDate = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    
                    historyItem.innerHTML = `
                        <div class="history-date">${formattedDate} - ${record.mode}</div>
                        <div class="history-stats">
                            <div class="history-stat">ÂæóÂàÜ: ${record.score}/${record.total}</div>
                            <div class="history-stat">Ê≠£Á¢∫Áéá: ${Math.round((record.score / record.total) * 100)}%</div>
                            <div class="history-stat">Áî®ÊôÇ: ${record.time}</div>
                        </div>
                    `;
                    
                    historyListElement.appendChild(historyItem);
                });
            }
            
            showScreen(historyScreen);
        }

        function saveHistory() {
            const record = {
                date: new Date().toISOString(),
                score: score,
                total: shuffledQuestions.length,
                time: formatTime(elapsedTime),
                mode: isVocabMode ? 'ÂñÆÂ≠óÊ∏¨È©ó' : (isPastQuestions ? 'Ê≠∑Â±ÜËÄÉÈ°å' : 'Ê®°Êì¨N4ËÄÉÈ°å')
            };
            
            history.unshift(record);
            
            if (history.length > 50) {
                history = history.slice(0, 50);
            }
            
            localStorage.setItem('n4QuizHistory', JSON.stringify(history));
        }

        function clearHistory() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊ∏¨È©óÁ¥ÄÈåÑÂóéÔºü')) {
                history = [];
                localStorage.removeItem('n4QuizHistory');
                showHistory();
            }
        }

        function exitApp() {
            if (confirm('Á¢∫ÂÆöË¶ÅÁµêÊùüÊ∏¨È©óÂóéÔºü')) {
                // Â¶ÇÊûúÊòØPWAÔºåÈóúÈñâÊáâÁî®
                if (window.navigator.standalone) {
                    window.close();
                } else {
                    alert('Ê∏¨È©óÂ∑≤ÁµêÊùüÔºåÊÇ®ÂèØ‰ª•ÈóúÈñâÊ≠§È†ÅÈù¢');
                }
            }
        }

        function showUpdateNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'success-message';
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.zIndex = '1000';
            notification.style.maxWidth = '80%';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 2000);
        }

// ========== È°åÂ∫´ËºâÂÖ•ËàáÊõ¥Êñ∞ ==========

function loadQuestionBanks() {
    console.log('ÈñãÂßãËºâÂÖ•È°åÂ∫´...');
    
    // Âêà‰ΩµÊâÄÊúâÊ®°Êì¨ËÄÉÈ°åÂ∫´ÔºàÈÄô‰∫õÊòØÁõ¥Êé•ÈÄèÈÅé <script> ËºâÂÖ•ÁöÑÔºâ
    try {
        questionBank = [];
        
        // ÈÄê‰∏ÄÊ™¢Êü•‰∏¶Âêà‰Ωµ6ÂÄãÂàÜÈ°ûÈ°åÂ∫´
        const typeQuestions = [
            { name: 'reading', var: readingQuestions },
            { name: 'writing', var: writingQuestions },
            { name: 'vocabulary', var: vocabularyQuestions },
            { name: 'synonym', var: synonymQuestions },
            { name: 'grammar', var: grammarQuestions },
            { name: 'reorder', var: reorderQuestions }
        ];
        
        typeQuestions.forEach(type => {
            if (typeof type.var !== 'undefined') {
                questionBank = questionBank.concat(type.var);
                console.log(`‚úÖ ${type.name} È°åÂ∫´ËºâÂÖ•ÊàêÂäü: ${type.var.length} È°å`);
            } else {
                console.warn(`‚ö†Ô∏è ${type.name} È°åÂ∫´Êú™ËºâÂÖ•`);
            }
        });
        
        console.log('Ê®°Êì¨N4ËÄÉÈ°åÈ°åÂ∫´Âêà‰ΩµÂÆåÊàêÔºåÁ∏ΩÈ°åÁõÆÊï∏Èáè:', questionBank.length);
        
    } catch (error) {
        console.error('ËºâÂÖ•Ê®°Êì¨ËÄÉÈ°åÂ∫´ÊôÇÁôºÁîüÈåØË™§:', error);
        questionBank = [];
    }
    
// ËºâÂÖ•Ê≠∑Â±ÜËÄÉÈ°åÔºàÊ™¢Êü•ÊâÄÊúâÂèØËÉΩÁöÑËÆäÊï∏ÂêçÁ®±Ôºâ
if (typeof window.pastQuestionBank !== 'undefined' && window.pastQuestionBank.length > 0) {
    pastQuestionBank = window.pastQuestionBank;
    console.log('‚úÖ Ê≠∑Â±ÜËÄÉÈ°åÈ°åÂ∫´ËºâÂÖ•ÊàêÂäü (window)ÔºåÈ°åÁõÆÊï∏Èáè:', pastQuestionBank.length);
} else if (typeof pastQuestionBank !== 'undefined' && pastQuestionBank.length > 0) {
    // Â¶ÇÊûúÁõ¥Êé•ÊúâÂÖ®ÂüüËÆäÊï∏
    console.log('‚úÖ Ê≠∑Â±ÜËÄÉÈ°åÈ°åÂ∫´ËºâÂÖ•ÊàêÂäü (global)ÔºåÈ°åÁõÆÊï∏Èáè:', pastQuestionBank.length);
} else {
    console.warn('‚ö†Ô∏è Ê≠∑Â±ÜËÄÉÈ°åÈ°åÂ∫´Êú™ËºâÂÖ•ÊàñÁÇ∫Á©∫ÔºåÂòóË©¶ÂãïÊÖãËºâÂÖ•...');
    pastQuestionBank = [];
    
    // ÂòóË©¶ÂãïÊÖãËºâÂÖ•
    loadScript('pastQuestionBank.js', () => {
        // ËºâÂÖ•ÂæåÂÜçÊ¨°Ê™¢Êü•ÊâÄÊúâÂèØËÉΩÁöÑËÆäÊï∏ÂêçÁ®±
        setTimeout(() => {
            if (typeof window.pastQuestionBank !== 'undefined' && window.pastQuestionBank.length > 0) {
                pastQuestionBank = window.pastQuestionBank;
                console.log('‚úÖ Ê≠∑Â±ÜËÄÉÈ°åÈ°åÂ∫´ÂãïÊÖãËºâÂÖ•ÊàêÂäü (window)ÔºåÈ°åÁõÆÊï∏Èáè:', pastQuestionBank.length);
            } else if (typeof pastQuestionBank !== 'undefined' && pastQuestionBank.length > 0) {
                console.log('‚úÖ Ê≠∑Â±ÜËÄÉÈ°åÈ°åÂ∫´ÂãïÊÖãËºâÂÖ•ÊàêÂäü (global)ÔºåÈ°åÁõÆÊï∏Èáè:', pastQuestionBank.length);
            } else {
                console.error('‚ùå Ê≠∑Â±ÜËÄÉÈ°åÈ°åÂ∫´ÂãïÊÖãËºâÂÖ•Â§±ÊïóÊàñÁÇ∫Á©∫Èô£Âàó');
            }
            updateQuestionCountLimit(); // Êõ¥Êñ∞È°åÁõÆÊï∏ÈáèÈôêÂà∂
        }, 100);
    });
}

// ËºâÂÖ•ÂñÆÂ≠óÊ∏¨È©óÈ°åÂ∫´ÔºàÊ™¢Êü•ÊâÄÊúâÂèØËÉΩÁöÑËÆäÊï∏ÂêçÁ®±Ôºâ
if (typeof window.vocabBank !== 'undefined' && window.vocabBank.length > 0) {
    vocabBank = window.vocabBank;
    console.log('‚úÖ ÂñÆÂ≠óÊ∏¨È©óÈ°åÂ∫´ËºâÂÖ•ÊàêÂäü (window)ÔºåÈ°åÁõÆÊï∏Èáè:', vocabBank.length);
} else if (typeof vocabBank !== 'undefined' && vocabBank.length > 0) {
    // Â¶ÇÊûúÁõ¥Êé•ÊúâÂÖ®ÂüüËÆäÊï∏
    console.log('‚úÖ ÂñÆÂ≠óÊ∏¨È©óÈ°åÂ∫´ËºâÂÖ•ÊàêÂäü (global)ÔºåÈ°åÁõÆÊï∏Èáè:', vocabBank.length);
} else {
    console.warn('‚ö†Ô∏è ÂñÆÂ≠óÊ∏¨È©óÈ°åÂ∫´Êú™ËºâÂÖ•ÊàñÁÇ∫Á©∫ÔºåÂòóË©¶ÂãïÊÖãËºâÂÖ•...');
    vocabBank = [];
    
    // ÂòóË©¶ÂãïÊÖãËºâÂÖ•
    loadScript('vocab_bank.js', () => {
        // ËºâÂÖ•ÂæåÂÜçÊ¨°Ê™¢Êü•ÊâÄÊúâÂèØËÉΩÁöÑËÆäÊï∏ÂêçÁ®±
        setTimeout(() => {
            if (typeof window.vocabBank !== 'undefined' && window.vocabBank.length > 0) {
                vocabBank = window.vocabBank;
                console.log('‚úÖ ÂñÆÂ≠óÊ∏¨È©óÈ°åÂ∫´ÂãïÊÖãËºâÂÖ•ÊàêÂäü (window)ÔºåÈ°åÁõÆÊï∏Èáè:', vocabBank.length);
            } else if (typeof vocabBank !== 'undefined' && vocabBank.length > 0) {
                console.log('‚úÖ ÂñÆÂ≠óÊ∏¨È©óÈ°åÂ∫´ÂãïÊÖãËºâÂÖ•ÊàêÂäü (global)ÔºåÈ°åÁõÆÊï∏Èáè:', vocabBank.length);
            } else {
                console.error('‚ùå ÂñÆÂ≠óÊ∏¨È©óÈ°åÂ∫´ÂãïÊÖãËºâÂÖ•Â§±ÊïóÊàñÁÇ∫Á©∫Èô£Âàó');
            }
            updateQuestionCountLimit(); // Êõ¥Êñ∞È°åÁõÆÊï∏ÈáèÈôêÂà∂
        }, 100);
    });
}
 
    // Ê™¢Êü•ÊúÄÁµÇÈ°åÂ∫´ÁãÄÊÖã
    setTimeout(() => {
        console.log('=== ÊúÄÁµÇÈ°åÂ∫´ËºâÂÖ•ÁãÄÊÖã ===');
        console.log('Ê®°Êì¨ËÄÉÈ°åÂ∫´:', questionBank.length, 'È°å');
        console.log('Ê≠∑Â±ÜËÄÉÈ°åÂ∫´:', pastQuestionBank.length, 'È°å');
        console.log('ÂñÆÂ≠óÊ∏¨È©óÈ°åÂ∫´:', vocabBank.length, 'È°å');
        
        if (questionBank.length === 0) {
            console.error('‚ùå Ê®°Êì¨ËÄÉÈ°åÂ∫´ËºâÂÖ•Â§±ÊïóÔºåË´ãÊ™¢Êü•6ÂÄãÂàÜÈ°ûÈ°åÂ∫´Ê™îÊ°à');
        }
    }, 1000);
}

function loadScript(src, callback) {
    const script = document.createElement('script');
    script.src = src;
    script.onload = callback;
    script.onerror = () => {
        console.error(`‚ùå ËºâÂÖ•È°åÂ∫´Â§±Êïó: ${src}`);
        callback();
    };
    document.head.appendChild(script);
}

function checkForUpdates() {
    // Ê®°Êì¨Ê™¢Êü•Êõ¥Êñ∞
    const lastUpdate = localStorage.getItem('lastUpdateCheck');
    const now = new Date().getTime();
    
    if (lastUpdate && (now - parseInt(lastUpdate)) < 60000) {
        showUpdateNotification('Â∑≤ÊòØÊúÄÊñ∞ÁâàÊú¨');
        return;
    }
    
    showUpdateNotification('Ê™¢Êü•Êõ¥Êñ∞‰∏≠...');
    
    // Ê®°Êì¨Êõ¥Êñ∞ÈÅéÁ®ã
    setTimeout(() => {
        localStorage.setItem('lastUpdateCheck', now.toString());
        showUpdateNotification('Â∑≤ÊòØÊúÄÊñ∞ÁâàÊú¨');
    }, 1500);
}





// ========== ÂàùÂßãÂåñÊáâÁî® ==========

function initApp() {
    console.log('ÂàùÂßãÂåñÊ∏¨È©óÁ≥ªÁµ±...');
    
    // ÂàùÂßãÂåñ‰∫ã‰ª∂Áõ£ËÅΩÂô®
    initEventListeners();
    
    // Ë®≠ÁΩÆÈ†êË®≠Ê∏¨È©óÈ°ûÂûã
    setQuestionType('simulate');
    
    // Âª∂ÈÅ≤ËºâÂÖ•È°åÂ∫´ÔºåÁ¢∫‰øùÊâÄÊúâscriptÈÉΩÂ∑≤ËºâÂÖ•
    setTimeout(() => {
        loadQuestionBanks();
        
        // ÂÜçÊ¨°Ê™¢Êü•È°åÂ∫´ÁãÄÊÖã
        setTimeout(() => {
            if (questionBank.length > 0) {
                console.log('‚úÖ È°åÂ∫´Âêà‰ΩµÊàêÂäüÔºåÁ∏ΩÈ°åÊï∏:', questionBank.length);
                // Êõ¥Êñ∞È°åÁõÆÊï∏ÈáèÈôêÂà∂
                updateQuestionCountLimit();
            } else {
                console.error('‚ùå È°åÂ∫´Âêà‰ΩµÂ§±ÊïóÔºåË´ãÊ™¢Êü•Ôºö');
                console.error('1. 6ÂÄãÈ°åÂ∫´Ê™îÊ°àÊòØÂê¶Â≠òÂú®');
                console.error('2. È°åÂ∫´Ê™îÊ°à‰∏≠ÁöÑËÆäÊï∏ÂêçÁ®±ÊòØÂê¶Ê≠£Á¢∫');
                console.error('3. Ê™îÊ°àË∑ØÂæëÊòØÂê¶Ê≠£Á¢∫');
                
                // È°ØÁ§∫ÈåØË™§Ë®äÊÅØÁµ¶‰ΩøÁî®ËÄÖ
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.innerHTML = 'È°åÂ∫´ËºâÂÖ•Â§±ÊïóÔºåË´ãÊ™¢Êü•È°åÂ∫´Ê™îÊ°àÊòØÂê¶Â≠òÂú®‰∏îÊ†ºÂºèÊ≠£Á¢∫';
                document.querySelector('.container').insertBefore(errorMsg, document.querySelector('h1').nextSibling);
            }
        }, 1000);
        
    }, 100);
    
    console.log('Ê∏¨È©óÁ≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê');
}

        // Áï∂È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñÊáâÁî®
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>